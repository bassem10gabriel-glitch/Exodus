<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>رحلة الخروج - مسابقة</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        /* Dynamic Desert Background */
        @keyframes desert-scroll {
            0% { background-position: 0 0, 30px 30px; }
            100% { background-position: -600px 600px, -570px 630px; }
        }

        body {
            background-color: #e5b45c;
            /* Sand dunes pattern */
            background-image: 
                radial-gradient(#d39e3b 15%, transparent 16%),
                radial-gradient(#d39e3b 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            animation: desert-scroll 30s linear infinite;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent body scroll, handle inside containers */
            height: 100vh;
        }

        /* Container styling */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* 3D Canvas wrapper */
        #avatar-canvas-container {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #avatar-canvas-container:active {
            cursor: grabbing;
        }

        /* Studio Mobile Scroll Fix */
        .studio-controls {
            overflow-y: auto;
            touch-action: pan-y;
            scrollbar-width: thin;
            scrollbar-color: #d39e3b #fef3c7;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #fef3c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #d39e3b; border-radius: 4px; }

        /* Hide sections initially */
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* Item Grid in Studio */
        .item-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .item-btn.selected {
            border-color: #d97706; /* amber-600 */
            background-color: #fef3c7; /* amber-50 */
            transform: scale(0.95);
        }

        .leaderboard-item {
            transition: transform 0.2s;
        }
        .leaderboard-item:hover {
            transform: translateY(-2px);
        }
        
        /* Toast Notification */
        #toast {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- 1. Login Screen -->
    <div id="login-screen" class="screen active justify-center items-center p-4">
        <div class="glass-panel rounded-2xl p-8 max-w-md w-full text-center relative overflow-hidden">
            <!-- Error Banner -->
            <div id="critical-error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 text-sm text-right font-bold rounded">
                <!-- Injected Error Text -->
            </div>

            <h1 class="text-4xl font-bold text-amber-800 mb-2">رحلة الخروج</h1>
            <p class="text-gray-600 mb-6">سجل الدخول أو أنشئ حساباً بنقرة واحدة</p>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <input type="email" id="email" required placeholder="البريد الإلكتروني" 
                        class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-amber-500 text-left" dir="ltr">
                </div>
                <div>
                    <input type="password" id="password" required placeholder="كلمة المرور (6 أحرف على الأقل)" minlength="6"
                        class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-amber-500 text-left" dir="ltr">
                </div>
                <button type="submit" id="login-btn" 
                    class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 flex justify-center items-center">
                    <span>دخول / ابدأ الرحلة</span>
                    <i class="fas fa-arrow-left mr-2"></i>
                </button>
            </form>
            <div id="login-error" class="text-red-500 mt-4 text-sm hidden font-bold"></div>
        </div>
    </div>

    <!-- 2. Main Screen (Leaderboard) -->
    <div id="main-screen" class="screen overflow-hidden">
        <!-- Header -->
        <header class="glass-panel px-4 py-3 flex justify-between items-center z-10 shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-bold text-amber-800 hidden sm:block">رحلة الخروج</h1>
                <button id="btn-edit-character" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition font-medium text-sm">
                    <i class="fas fa-user-edit ml-1"></i> تعديل الشخصية
                </button>
            </div>
            <div class="flex items-center gap-3">
                <button id="btn-read-message" class="text-amber-700 hover:text-amber-900 text-xl relative" title="رسالة القائد">
                    <i class="fas fa-bookmark"></i>
                    <span class="absolute -top-1 -right-1 bg-red-500 w-3 h-3 rounded-full animate-ping hidden" id="msg-indicator"></span>
                </button>
                <button id="btn-logout" class="text-gray-500 hover:text-red-600 ml-2" title="تسجيل الخروج">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Leaderboard Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-5xl mx-auto">
                <div class="flex justify-between items-end mb-6">
                    <h2 class="text-3xl font-bold text-amber-900 drop-shadow-md bg-white/50 px-4 py-1 rounded-xl">لوحة الشرف</h2>
                    <div class="text-amber-900 font-bold bg-white/70 px-4 py-2 rounded-xl shadow-sm">
                        مجموع النقاط: <span id="current-user-score" class="text-2xl text-amber-600">0</span>
                    </div>
                </div>

                <div id="leaderboard-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- Leaderboard items injected here via JS -->
                </div>
            </div>
        </main>

        <!-- Admin Footer -->
        <footer class="p-4 text-center shrink-0 bg-white/50 border-t border-amber-200 cursor-pointer hover:bg-amber-100 transition" id="btn-open-admin">
            <div class="text-sm font-bold text-amber-800/80 flex items-center justify-center gap-2">
                <i class="fas fa-lock"></i> لوحة الإدارة (للمسؤولين لتغيير النقاط والرسائل)
            </div>
        </footer>
    </div>

    <!-- 3. Studio Screen -->
    <div id="studio-screen" class="screen bg-white">
        <!-- Studio Header -->
        <header class="bg-amber-800 text-white px-4 py-3 flex justify-between items-center shrink-0 shadow-md z-20">
            <h2 class="text-xl font-bold"><i class="fas fa-cube ml-2"></i> ستوديو الشخصية</h2>
            <button id="btn-save-character" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-bold transition flex items-center shadow-lg">
                <i class="fas fa-save ml-2"></i> حفظ وعودة
            </button>
        </header>

        <!-- Split Layout -->
        <div class="flex flex-col md:flex-row flex-1 overflow-hidden relative">
            
            <!-- 3D Canvas Area (Top on mobile, Left on Desktop) -->
            <div class="w-full md:w-1/2 h-1/2 md:h-full bg-gradient-to-b from-amber-100 to-yellow-50 relative border-b md:border-b-0 md:border-l border-amber-200">
                <div id="avatar-canvas-container"></div>
                <!-- Controls Hint -->
                <div class="absolute bottom-4 left-0 right-0 text-center pointer-events-none">
                    <span class="bg-black/40 text-white px-3 py-1 rounded-full text-xs backdrop-blur-sm">اسحب لتدوير الشخصية</span>
                </div>
            </div>

            <!-- Controls Area (Bottom on mobile, Right on Desktop) -->
            <div class="w-full md:w-1/2 h-1/2 md:h-full flex flex-col bg-gray-50">
                
                <!-- Category Tabs -->
                <div class="flex overflow-x-auto bg-white shadow-sm shrink-0 no-scrollbar hide-scrollbar p-2 gap-2 border-b">
                    <button class="tab-btn active px-4 py-2 rounded-full font-bold text-sm bg-amber-100 text-amber-800 whitespace-nowrap" data-tab="shape">الجسم والوجه</button>
                    <button class="tab-btn px-4 py-2 rounded-full font-bold text-sm text-gray-600 hover:bg-gray-100 whitespace-nowrap" data-tab="hair">الشعر</button>
                    <button class="tab-btn px-4 py-2 rounded-full font-bold text-sm text-gray-600 hover:bg-gray-100 whitespace-nowrap" data-tab="face">الملامح</button>
                    <button class="tab-btn px-4 py-2 rounded-full font-bold text-sm text-gray-600 hover:bg-gray-100 whitespace-nowrap" data-tab="clothes">الملابس</button>
                    <button class="tab-btn px-4 py-2 rounded-full font-bold text-sm text-gray-600 hover:bg-gray-100 whitespace-nowrap" data-tab="accessories">الإكسسوارات</button>
                    <button class="tab-btn px-4 py-2 rounded-full font-bold text-sm text-gray-600 hover:bg-gray-100 whitespace-nowrap" data-tab="colors">الألوان</button>
                </div>

                <!-- Tab Contents (The Scrollable Area) -->
                <div class="studio-controls p-4 flex-1">
                    
                    <!-- Tab: Shape -->
                    <div id="tab-shape" class="tab-content block">
                        <h3 class="text-gray-500 text-sm mb-2 font-bold">شكل الوجه</h3>
                        <div class="grid grid-cols-3 gap-3 mb-6">
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('shape', 'round')">
                                <i class="fas fa-circle text-gray-400 text-2xl"></i><span>دائري</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('shape', 'oval')">
                                <i class="fas fa-egg text-gray-400 text-2xl"></i><span>بيضاوي</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('shape', 'square')">
                                <i class="fas fa-square text-gray-400 text-2xl"></i><span>مربع</span>
                            </button>
                        </div>

                        <h3 class="text-gray-500 text-sm mb-2 font-bold">بنية الجسم</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('body', 'average')">
                                <i class="fas fa-child text-gray-400 text-2xl"></i><span>متوسط</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('body', 'slim')">
                                <i class="fas fa-street-view text-gray-400 text-2xl"></i><span>نحيف</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('body', 'muscular')">
                                <i class="fas fa-dumbbell text-gray-400 text-2xl"></i><span>عضلي</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('body', 'chubby')">
                                <i class="fas fa-hamburger text-gray-400 text-2xl"></i><span>ممتلئ</span>
                            </button>
                        </div>
                    </div>

                    <!-- Tab: Hair -->
                    <div id="tab-hair" class="tab-content hidden">
                        <div class="grid grid-cols-3 gap-3">
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="updateConfig('hair', 'none')">
                                <i class="fas fa-user text-gray-400 text-xl"></i><span class="text-sm">أصلع</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="updateConfig('hair', 'short')">
                                <i class="fas fa-cut text-gray-400 text-xl"></i><span class="text-sm">قصير</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="updateConfig('hair', 'long')">
                                <i class="fas fa-wind text-gray-400 text-xl"></i><span class="text-sm">طويل</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="updateConfig('hair', 'spiky')">
                                <i class="fas fa-bolt text-gray-400 text-xl"></i><span class="text-sm">سبايكي</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="updateConfig('hair', 'bob')">
                                <i class="fas fa-female text-gray-400 text-xl"></i><span class="text-sm">بوب</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="updateConfig('hair', 'curly')">
                                <i class="fas fa-cloud text-gray-400 text-xl"></i><span class="text-sm">كيرلي</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="updateConfig('hair', 'ponytail')">
                                <i class="fas fa-ring text-gray-400 text-xl"></i><span class="text-sm">ذيل حصان</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="updateConfig('hair', 'mohawk')">
                                <i class="fas fa-fire text-gray-400 text-xl"></i><span class="text-sm">موهوك</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="updateConfig('hair', 'headdress')">
                                <i class="fab fa-old-republic text-gray-400 text-xl"></i><span class="text-sm">فرعوني</span>
                            </button>
                        </div>
                    </div>

                    <!-- Tab: Face -->
                    <div id="tab-face" class="tab-content hidden">
                        <h3 class="text-gray-500 text-sm mb-2 font-bold">العيون</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center" onclick="updateConfig('eyes', 'normal')">عادي</button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center" onclick="updateConfig('eyes', 'wide')">واسعة</button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center" onclick="updateConfig('eyes', 'sleepy')">ناعسة</button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center" onclick="updateConfig('eyes', 'angry')">غاضبة</button>
                        </div>
                        <h3 class="text-gray-500 text-sm mb-2 font-bold">الفم</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center" onclick="updateConfig('mouth', 'smile')">ابتسامة</button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center" onclick="updateConfig('mouth', 'open')">مفتوح</button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center" onclick="updateConfig('mouth', 'serious')">جاد</button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center" onclick="updateConfig('mouth', 'laugh')">ضحكة</button>
                        </div>
                    </div>

                    <!-- Tab: Clothes -->
                    <div id="tab-clothes" class="tab-content hidden">
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('clothes', 'casual')">
                                <i class="fas fa-tshirt text-gray-400 text-2xl"></i><span>كاجوال</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('clothes', 'robe')">
                                <i class="fas fa-user-tie text-gray-400 text-2xl"></i><span>رداء طويل</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('clothes', 'armor')">
                                <i class="fas fa-shield-alt text-gray-400 text-2xl"></i><span>درع حربي</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('clothes', 'pharaonic')">
                                <i class="fas fa-sun text-gray-400 text-2xl"></i><span>فرعوني</span>
                            </button>
                            <button class="item-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-2" onclick="updateConfig('clothes', 'suit')">
                                <i class="fas fa-briefcase text-gray-400 text-2xl"></i><span>بدلة رسمية</span>
                            </button>
                        </div>
                    </div>

                    <!-- Tab: Accessories (Multi-Select) -->
                    <div id="tab-accessories" class="tab-content hidden">
                        <p class="text-xs text-amber-600 mb-3"><i class="fas fa-info-circle"></i> يمكنك اختيار أكثر من قطعة</p>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('crown')">
                                <i class="fas fa-crown text-gray-400 text-xl"></i><span class="text-sm">تاج</span>
                            </button>
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('hat')">
                                <i class="fas fa-hat-cowboy text-gray-400 text-xl"></i><span class="text-sm">قبعة</span>
                            </button>
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('halo')">
                                <i class="far fa-circle text-gray-400 text-xl"></i><span class="text-sm">هالة</span>
                            </button>
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('glasses')">
                                <i class="fas fa-glasses text-gray-400 text-xl"></i><span class="text-sm">نظارة</span>
                            </button>
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('sunglasses')">
                                <i class="fas fa-mask text-gray-400 text-xl"></i><span class="text-sm">نظارة شمسية</span>
                            </button>
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('beard')">
                                <i class="fas fa-user-secret text-gray-400 text-xl"></i><span class="text-sm">لحية</span>
                            </button>
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('headphones')">
                                <i class="fas fa-headphones text-gray-400 text-xl"></i><span class="text-sm">سماعات</span>
                            </button>
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('cape')">
                                <i class="fab fa-superpowers text-gray-400 text-xl"></i><span class="text-sm">عباءة بطل</span>
                            </button>
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('backpack')">
                                <i class="fas fa-briefcase-medical text-gray-400 text-xl"></i><span class="text-sm">حقيبة</span>
                            </button>
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('wings')">
                                <i class="fas fa-feather-alt text-gray-400 text-xl"></i><span class="text-sm">أجنحة</span>
                            </button>
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('scarf')">
                                <i class="fas fa-stream text-gray-400 text-xl"></i><span class="text-sm">وشاح</span>
                            </button>
                            <button class="item-btn acc-btn bg-white p-3 rounded-xl shadow-sm flex flex-col items-center gap-1" onclick="toggleAccessory('staff')">
                                <i class="fas fa-magic text-gray-400 text-xl"></i><span class="text-sm">عصا الراعي</span>
                            </button>
                        </div>
                    </div>

                    <!-- Tab: Colors -->
                    <div id="tab-colors" class="tab-content hidden space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">لون البشرة</label>
                            <input type="color" id="color-skin" class="w-full h-10 rounded cursor-pointer" oninput="updateColor('skin', this.value)">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">لون الشعر/اللحية</label>
                            <input type="color" id="color-hair" class="w-full h-10 rounded cursor-pointer" oninput="updateColor('hair', this.value)">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">لون الملابس الأساسي</label>
                            <input type="color" id="color-clothes" class="w-full h-10 rounded cursor-pointer" oninput="updateColor('clothes', this.value)">
                        </div>
                    </div>
                    
                    <!-- Bottom spacing for scrolling -->
                    <div class="h-12"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Admin Dashboard Screen -->
    <div id="admin-screen" class="screen bg-gray-100 overflow-hidden flex flex-col">
        <header class="bg-gray-800 text-white px-4 py-3 flex justify-between items-center shrink-0">
            <h2 class="text-xl font-bold"><i class="fas fa-user-shield ml-2"></i> لوحة التحكم</h2>
            <button id="btn-close-admin" class="text-gray-300 hover:text-white"><i class="fas fa-times text-xl"></i></button>
        </header>
        
        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
            <!-- Broadcast Message -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-2">رسالة القائد (Broadcast)</h3>
                <textarea id="admin-broadcast-msg" rows="3" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-amber-500 text-sm" placeholder="اكتب آية أو رسالة للجميع..."></textarea>
                <button id="btn-save-broadcast" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition">نشر الرسالة</button>
            </div>

            <!-- Users List -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-right text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-3">المستخدم</th>
                            <th class="p-3 text-center">النقاط</th>
                            <th class="p-3 text-center">التحكم بالنقاط</th>
                            <th class="p-3 text-center">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="admin-users-list" class="divide-y divide-gray-100">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Broadcast Modal -->
    <div id="modal-message" class="fixed inset-0 bg-black/50 z-50 hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl transform scale-95 transition-transform duration-300 relative">
            <button class="absolute top-4 left-4 text-gray-400 hover:text-gray-700 close-modal"><i class="fas fa-times text-xl"></i></button>
            <div class="text-center mb-4 text-amber-600 text-4xl">
                <i class="fas fa-book-open"></i>
            </div>
            <h3 class="text-xl font-bold text-center text-amber-900 mb-4 border-b pb-2">رسالة القائد</h3>
            <p id="broadcast-content" class="text-gray-700 text-center text-lg leading-relaxed font-serif"></p>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="modal-admin-login" class="fixed inset-0 bg-black/50 z-50 hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">كلمة مرور الإدارة</h3>
            <input type="password" id="admin-password" class="w-full px-4 py-2 border rounded-lg text-center mb-4" dir="ltr" placeholder="***">
            <div class="flex gap-2">
                <button id="btn-verify-admin" class="flex-1 bg-gray-800 text-white py-2 rounded-lg hover:bg-gray-900">دخول</button>
                <button class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 close-modal">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 px-6 py-3 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3 bg-gray-800 text-white pointer-events-none">
        <i class="fas fa-info-circle" id="toast-icon"></i>
        <span id="toast-msg" class="font-bold"></span>
    </div>

    <script type="module">
        // --- 1. FIREBASE SETUP & RULES COMPLIANCE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhqaIj8TBIwt_mWrWhppT1Wvny6WHci3g",
            authDomain: "exodus2-80162.firebaseapp.com",
            projectId: "exodus2-80162",
            storageBucket: "exodus2-80162.firebasestorage.app",
            messagingSenderId: "651550681077",
            appId: "1:651550681077:web:4476b873ca3762939122bc"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'exodus-app-3d';

        // Paths following MANDATORY RULE 1
        const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
        const settingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'settings');

        // Global State
        let currentUser = null;
        let userData = null;
        let isFirstTime = false;
        let allUsers = [];
        let broadcastMsg = "فقال الرب لموسى: ما لك تصرخ إلي؟ قل لبني إسرائيل أن يرحلوا (خروج 14: 15)";

        // Character Configuration State
        let currentConfig = {
            shape: 'round',
            body: 'average',
            clothes: 'casual',
            hair: 'short',
            eyes: 'normal',
            mouth: 'smile',
            accessories: [], // Array for multi-select
            colors: {
                skin: '#ffcda0',
                hair: '#3b2512',
                clothes: '#3498db'
            }
        };

        // UI Error Handler Helper
        function showCriticalError(title, steps) {
            const banner = document.getElementById('critical-error-banner');
            banner.innerHTML = `<strong>${title}</strong><ul class="list-disc pr-5 mt-2 text-xs">${steps}</ul>`;
            banner.classList.remove('hidden');
        }

        // Global Toast Notification
        window.showToast = function(msg, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-xl shadow-2xl transition-all duration-300 z-50 flex items-center gap-3 ${isError ? 'bg-red-600' : 'bg-green-600'} text-white`;
            toast.style.transform = 'translateY(0)';
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.transform = 'translateY(20px)';
                toast.style.opacity = '0';
            }, 3000);
        };

        // --- 2. THREE.JS PROCEDURAL ENGINE ---
        let scene, camera, renderer, characterGroup;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        const canvasContainer = document.getElementById('avatar-canvas-container');

        function initThreeJS() {
            scene = new THREE.Scene();
            
            // Camera setup
            camera = new THREE.PerspectiveCamera(45, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 100);
            camera.position.set(0, 0.5, 3);

            // Renderer setup (CRITICAL: preserveDrawingBuffer for snapshot)
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            canvasContainer.appendChild(renderer.domElement);

            // Lights
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
            hemiLight.position.set(0, 10, 0);
            scene.add(hemiLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
            dirLight.position.set(2, 5, 5);
            dirLight.castShadow = true;
            scene.add(dirLight);

            characterGroup = new THREE.Group();
            characterGroup.position.y = -1.0;
            scene.add(characterGroup);

            // Interaction (Drag to rotate)
            const handleStart = (e) => { isDragging = true; previousMousePosition.x = e.touches ? e.touches[0].clientX : e.clientX; };
            const handleEnd = () => { isDragging = false; };
            const handleMove = (e) => {
                if(isDragging) {
                    const currentX = e.touches ? e.touches[0].clientX : e.clientX;
                    const deltaX = currentX - previousMousePosition.x;
                    characterGroup.rotation.y += deltaX * 0.01;
                    previousMousePosition.x = currentX;
                }
            };

            renderer.domElement.addEventListener('mousedown', handleStart);
            window.addEventListener('mouseup', handleEnd);
            window.addEventListener('mousemove', handleMove);
            
            renderer.domElement.addEventListener('touchstart', handleStart, {passive: false});
            window.addEventListener('touchend', handleEnd);
            window.addEventListener('touchmove', handleMove, {passive: false});

            // Handle Resize
            window.addEventListener('resize', () => {
                if(!canvasContainer.clientWidth) return;
                camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            });

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // --- PROCEDURAL BUILDER ---
        function buildAvatar() {
            if(!characterGroup) return;
            
            // Clear existing
            while(characterGroup.children.length > 0){ 
                const child = characterGroup.children[0];
                characterGroup.remove(child); 
            }

            // Materials
            const skinMat = new THREE.MeshStandardMaterial({ color: currentConfig.colors.skin, roughness: 0.4 });
            const hairMat = new THREE.MeshStandardMaterial({ color: currentConfig.colors.hair, roughness: 0.8 });
            const clothesMat = new THREE.MeshStandardMaterial({ color: currentConfig.colors.clothes, roughness: 0.6 });
            const darkMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
            const whiteMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
            const goldMat = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.8, roughness: 0.2 });

            const headGroup = new THREE.Group();
            headGroup.position.y = 1.6;
            characterGroup.add(headGroup);

            // 1. SHAPE (Head)
            let headGeo;
            if (currentConfig.shape === 'round') {
                headGeo = new THREE.SphereGeometry(0.38, 32, 32);
            } else if (currentConfig.shape === 'oval') {
                headGeo = new THREE.SphereGeometry(0.38, 32, 32);
                headGeo.scale(0.85, 1.2, 1.0); // Z=1.0 prevents facial features clipping
            } else { // square
                headGeo = new THREE.BoxGeometry(0.65, 0.65, 0.76); // Depth 0.76 ensures front face matches round
            }
            const headMesh = new THREE.Mesh(headGeo, skinMat);
            headMesh.castShadow = true;
            headGroup.add(headMesh);

            // 2. BODY & CLOTHES
            const bodyGroup = new THREE.Group();
            bodyGroup.position.y = 0.7;
            characterGroup.add(bodyGroup);

            // Dynamic scaling to prevent clipping
            let topRadius = 0.3;
            let botRadius = 0.3;
            if (currentConfig.body === 'slim') { topRadius = 0.22; botRadius = 0.22; }
            if (currentConfig.body === 'chubby') { topRadius = 0.4; botRadius = 0.45; }
            if (currentConfig.body === 'muscular') { topRadius = 0.45; botRadius = 0.25; }

            let torsoGeo = new THREE.CylinderGeometry(topRadius, botRadius, 1.0, 32);
            
            let activeClothesMat = clothesMat;
            if(currentConfig.clothes === 'armor') activeClothesMat = new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.7, roughness: 0.3 });
            if(currentConfig.clothes === 'suit') activeClothesMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
            if(currentConfig.clothes === 'pharaonic') activeClothesMat = skinMat; // Bare chest

            const torso = new THREE.Mesh(torsoGeo, activeClothesMat);
            torso.castShadow = true;
            bodyGroup.add(torso);

            // Legs based on botRadius
            const legGeo = new THREE.CylinderGeometry(0.15, 0.12, 0.8, 16);
            const legMat = currentConfig.clothes === 'pharaonic' ? whiteMat : (currentConfig.clothes === 'suit' ? activeClothesMat : darkMat);
            const legL = new THREE.Mesh(legGeo, legMat);
            legL.position.set(-botRadius/2 - 0.05, -0.9, 0);
            const legR = new THREE.Mesh(legGeo, legMat);
            legR.position.set(botRadius/2 + 0.05, -0.9, 0);
            bodyGroup.add(legL, legR);

            // Arms based on topRadius
            const armGeo = new THREE.CylinderGeometry(0.12, 0.1, 0.8, 16);
            const armL = new THREE.Mesh(armGeo, currentConfig.clothes === 'pharaonic' ? skinMat : activeClothesMat);
            armL.position.set(-topRadius - 0.1, -0.2, 0);
            armL.rotation.z = Math.PI / 8;
            const armR = new THREE.Mesh(armGeo, currentConfig.clothes === 'pharaonic' ? skinMat : activeClothesMat);
            armR.position.set(topRadius + 0.1, -0.2, 0);
            armR.rotation.z = -Math.PI / 8;
            bodyGroup.add(armL, armR);

            // Clothes specific details
            if (currentConfig.clothes === 'robe') {
                const robeGeo = new THREE.CylinderGeometry(botRadius, botRadius + 0.2, 0.9, 32);
                const robe = new THREE.Mesh(robeGeo, activeClothesMat);
                robe.position.y = -0.8;
                bodyGroup.add(robe);
            } else if (currentConfig.clothes === 'armor') {
                const padGeo = new THREE.SphereGeometry(0.2, 16, 16);
                const padL = new THREE.Mesh(padGeo, activeClothesMat);
                padL.position.set(-topRadius - 0.1, 0.4, 0);
                const padR = new THREE.Mesh(padGeo, activeClothesMat);
                padR.position.set(topRadius + 0.1, 0.4, 0);
                bodyGroup.add(padL, padR);
            } else if (currentConfig.clothes === 'pharaonic') {
                const skirtGeo = new THREE.CylinderGeometry(botRadius + 0.02, botRadius + 0.15, 0.5, 32);
                const skirt = new THREE.Mesh(skirtGeo, whiteMat);
                skirt.position.y = -0.5;
                bodyGroup.add(skirt);
                // Usekh collar
                const collarGeo = new THREE.TorusGeometry(topRadius + 0.05, 0.08, 16, 32);
                const collar = new THREE.Mesh(collarGeo, goldMat);
                collar.rotation.x = Math.PI / 2;
                collar.position.y = 0.45;
                bodyGroup.add(collar);
            } else if (currentConfig.clothes === 'suit') {
                const tieGeo = new THREE.BoxGeometry(0.08, 0.4, 0.05);
                const tie = new THREE.Mesh(tieGeo, new THREE.MeshStandardMaterial({color: 0x880000}));
                const tieZ = ((topRadius + botRadius) / 2) + 0.02;
                tie.position.set(0, 0.1, tieZ);
                bodyGroup.add(tie);
            }

            // 3. HAIR
            if (currentConfig.hair !== 'none') {
                if (currentConfig.hair === 'headdress') {
                    // Start at angle 72 deg, sweep through the back, end at 288 deg (frames the face perfectly)
                    const hdGeo = new THREE.CylinderGeometry(0.42, 0.55, 0.8, 32, 1, false, Math.PI * 0.4, Math.PI * 1.2);
                    const hdMat = new THREE.MeshStandardMaterial({color: 0x1e3a8a});
                    const hd = new THREE.Mesh(hdGeo, hdMat);
                    hd.position.set(0, 0.1, 0);
                    headGroup.add(hd);
                    
                    const hdBand = new THREE.TorusGeometry(0.41, 0.05, 16, 32);
                    const band = new THREE.Mesh(hdBand, goldMat);
                    band.rotation.x = Math.PI/2;
                    band.position.y = 0.2;
                    headGroup.add(band);
                } else if (currentConfig.hair === 'short') {
                    const hGeo = new THREE.SphereGeometry(0.39, 32, 32, 0, Math.PI*2, 0, Math.PI/2);
                    const hMesh = new THREE.Mesh(hGeo, hairMat);
                    hMesh.position.y = 0.02;
                    headGroup.add(hMesh);
                } else if (currentConfig.hair === 'spiky') {
                    const hGeo = new THREE.SphereGeometry(0.39, 32, 32, 0, Math.PI*2, 0, Math.PI/2);
                    const hMesh = new THREE.Mesh(hGeo, hairMat);
                    hMesh.position.y = 0.02;
                    headGroup.add(hMesh);
                    for(let i=0; i<15; i++) {
                        const spike = new THREE.Mesh(new THREE.ConeGeometry(0.08, 0.25, 8), hairMat);
                        spike.position.set((Math.random()-0.5)*0.6, 0.3 + Math.random()*0.2, (Math.random()-0.5)*0.6);
                        spike.lookAt(0,0,0);
                        spike.rotation.x -= Math.PI/2;
                        headGroup.add(spike);
                    }
                } else if (currentConfig.hair === 'curly') {
                    for(let i=0; i<30; i++) {
                        const curl = new THREE.Mesh(new THREE.SphereGeometry(0.12, 8, 8), hairMat);
                        const angle1 = Math.random() * Math.PI * 2;
                        const angle2 = Math.random() * Math.PI/2.5; // upper half
                        const r = 0.38;
                        curl.position.set(r*Math.sin(angle2)*Math.cos(angle1), r*Math.cos(angle2), r*Math.sin(angle2)*Math.sin(angle1));
                        headGroup.add(curl);
                    }
                } else if (currentConfig.hair === 'ponytail') {
                    const base = new THREE.Mesh(new THREE.SphereGeometry(0.39, 32, 32, 0, Math.PI*2, 0, Math.PI/2.5), hairMat);
                    headGroup.add(base);
                    const tail = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.02, 0.5), hairMat);
                    tail.position.set(0, 0, -0.4);
                    tail.rotation.x = -Math.PI/6;
                    headGroup.add(tail);
                    const tie = new THREE.Mesh(new THREE.TorusGeometry(0.1, 0.03, 8, 16), new THREE.MeshStandardMaterial({color: 0xff0000}));
                    tie.position.set(0, 0.2, -0.38);
                    tie.rotation.x = Math.PI/2;
                    headGroup.add(tie);
                } else if (currentConfig.hair === 'mohawk') {
                    const hGeo = new THREE.BoxGeometry(0.15, 0.3, 0.7);
                    const hMesh = new THREE.Mesh(hGeo, hairMat);
                    hMesh.position.set(0, 0.45, 0);
                    headGroup.add(hMesh);
                } else {
                    const hGeo = new THREE.SphereGeometry(0.40, 32, 32, 0, Math.PI*2, 0, Math.PI/1.8);
                    const hMesh = new THREE.Mesh(hGeo, hairMat);
                    if(currentConfig.hair === 'long') hMesh.scale.set(1, 1.5, 1);
                    headGroup.add(hMesh);
                }
            }

            // 4. FACE (Eyes & Mouth)
            const eyeGeo = new THREE.SphereGeometry(0.06, 16, 16);
            let pupilScale = 0.03;
            if(currentConfig.eyes === 'wide') { eyeGeo.scale(1.5, 1.5, 1.5); pupilScale = 0.02; }
            if(currentConfig.eyes === 'sleepy') { eyeGeo.scale(1, 0.5, 1); }
            
            // Placed precisely to float on the 0.38 Z limit
            const eyeL = new THREE.Mesh(eyeGeo, whiteMat);
            eyeL.position.set(-0.15, 0.1, 0.36);
            const eyeR = new THREE.Mesh(eyeGeo, whiteMat);
            eyeR.position.set(0.15, 0.1, 0.36);
            
            const pupilGeo = new THREE.SphereGeometry(pupilScale, 16, 16);
            const pupilL = new THREE.Mesh(pupilGeo, darkMat);
            pupilL.position.set(-0.15, 0.1, 0.40);
            const pupilR = new THREE.Mesh(pupilGeo, darkMat);
            pupilR.position.set(0.15, 0.1, 0.40);

            if(currentConfig.eyes === 'angry') {
                const browGeo = new THREE.BoxGeometry(0.15, 0.03, 0.05);
                const browL = new THREE.Mesh(browGeo, darkMat);
                browL.position.set(-0.15, 0.2, 0.42);
                browL.rotation.z = -0.2;
                const browR = new THREE.Mesh(browGeo, darkMat);
                browR.position.set(0.15, 0.2, 0.42);
                browR.rotation.z = 0.2;
                headGroup.add(browL, browR);
            }

            headGroup.add(eyeL, eyeR, pupilL, pupilR);

            let mouthMesh;
            if (currentConfig.mouth === 'smile' || currentConfig.mouth === 'laugh') {
                const mGeo = new THREE.TorusGeometry(0.1, 0.02, 16, 32, Math.PI);
                mouthMesh = new THREE.Mesh(mGeo, currentConfig.mouth === 'laugh' ? new THREE.MeshStandardMaterial({color:0x550000}) : darkMat);
                mouthMesh.rotation.z = Math.PI;
                mouthMesh.position.set(0, -0.1, 0.39);
            } else if (currentConfig.mouth === 'open') {
                mouthMesh = new THREE.Mesh(new THREE.CircleGeometry(0.06, 16), darkMat);
                mouthMesh.position.set(0, -0.15, 0.39);
            } else { // serious
                mouthMesh = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.02, 0.02), darkMat);
                mouthMesh.position.set(0, -0.15, 0.39);
            }
            headGroup.add(mouthMesh);

            // 5. ACCESSORIES
            const accs = currentConfig.accessories || [];
            if(accs.includes('crown')) {
                const cGeo = new THREE.CylinderGeometry(0.3, 0.25, 0.2, 16, 1, true);
                const crown = new THREE.Mesh(cGeo, goldMat);
                crown.position.set(0, 0.48, 0); // slightly higher
                headGroup.add(crown);
            }
            if(accs.includes('hat')) {
                const hGeo = new THREE.ConeGeometry(0.4, 0.4, 32);
                const hat = new THREE.Mesh(hGeo, darkMat);
                hat.position.set(0, 0.55, 0);
                const brim = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 0.05, 32), darkMat);
                brim.position.set(0, 0.35, 0);
                headGroup.add(hat, brim);
            }
            if(accs.includes('halo')) {
                const halo = new THREE.Mesh(new THREE.TorusGeometry(0.3, 0.03, 16, 32), goldMat);
                halo.rotation.x = Math.PI/2;
                halo.position.set(0, 0.8, 0);
                headGroup.add(halo);
            }
            if(accs.includes('glasses') || accs.includes('sunglasses')) {
                const gMat = accs.includes('sunglasses') ? darkMat : new THREE.MeshStandardMaterial({color:0x111111, wireframe: true});
                const gGeo = new THREE.TorusGeometry(0.12, 0.02, 8, 32);
                const gl = new THREE.Mesh(gGeo, gMat); gl.position.set(-0.15, 0.1, 0.43);
                const gr = new THREE.Mesh(gGeo, gMat); gr.position.set(0.15, 0.1, 0.43);
                const bridge = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.02, 0.02), darkMat);
                bridge.position.set(0, 0.1, 0.43);
                headGroup.add(gl, gr, bridge);
                if(accs.includes('sunglasses')) {
                    const fill = new THREE.Mesh(new THREE.CircleGeometry(0.11, 16), darkMat);
                    fill.position.set(-0.15, 0.1, 0.425);
                    const fill2 = fill.clone(); fill2.position.set(0.15, 0.1, 0.425);
                    headGroup.add(fill, fill2);
                }
            }
            if(accs.includes('beard')) {
                const bGeo = new THREE.BoxGeometry(0.4, 0.2, 0.2);
                const beard = new THREE.Mesh(bGeo, hairMat);
                beard.position.set(0, -0.3, 0.38);
                headGroup.add(beard);
            }
            if(accs.includes('headphones')) {
                const bandGeo = new THREE.TorusGeometry(0.42, 0.04, 16, 32, Math.PI);
                const band = new THREE.Mesh(bandGeo, darkMat);
                band.position.set(0, 0.05, 0);
                const cup = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 0.1, 16), darkMat);
                cup.rotation.z = Math.PI/2;
                cup.position.set(-0.45, 0, 0);
                const cup2 = cup.clone(); cup2.position.set(0.45, 0, 0);
                headGroup.add(band, cup, cup2);
            }
            
            // Body Accessories calculate based on body radius to avoid clipping
            const backZ = -((topRadius + botRadius) / 2);

            if(accs.includes('cape')) {
                const cape = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.05), new THREE.MeshStandardMaterial({color: 0xaa0000}));
                cape.position.set(0, -0.2, backZ - 0.05);
                cape.rotation.x = -0.1;
                bodyGroup.add(cape);
            }
            if(accs.includes('backpack')) {
                const pack = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.6, 0.25), new THREE.MeshStandardMaterial({color: 0x8b4513}));
                pack.position.set(0, 0, backZ - 0.15);
                bodyGroup.add(pack);
            }
            if(accs.includes('wings')) {
                const wingGeo = new THREE.ConeGeometry(0.3, 1.2, 4);
                const wingL = new THREE.Mesh(wingGeo, whiteMat);
                wingL.position.set(-0.35, 0, backZ - 0.05); wingL.rotation.z = Math.PI/4;
                const wingR = new THREE.Mesh(wingGeo, whiteMat);
                wingR.position.set(0.35, 0, backZ - 0.05); wingR.rotation.z = -Math.PI/4;
                bodyGroup.add(wingL, wingR);
            }
            if(accs.includes('scarf')) {
                const scarf = new THREE.Mesh(new THREE.TorusGeometry(topRadius + 0.1, 0.08, 16, 32), new THREE.MeshStandardMaterial({color: 0xcc0000}));
                scarf.rotation.x = Math.PI/2;
                scarf.position.set(0, 0.55, 0);
                bodyGroup.add(scarf);
            }
            if(accs.includes('staff')) {
                const staffGeo = new THREE.CylinderGeometry(0.03, 0.02, 2.0, 8);
                const staff = new THREE.Mesh(staffGeo, new THREE.MeshStandardMaterial({color: 0x5c4033}));
                staff.position.set(topRadius + 0.3, -0.5, 0.2);
                staff.rotation.x = Math.PI/12;
                bodyGroup.add(staff);
            }

            // Ensure rendering after build
            renderer.render(scene, camera);
        }

        // --- UI & LOGIC INTEGRATION ---
        
        // Expose globally for HTML onclicks
        window.updateConfig = function(key, value) {
            currentConfig[key] = value;
            buildAvatar();
            updateUISelection();
        };

        window.toggleAccessory = function(acc) {
            if(!currentConfig.accessories) currentConfig.accessories = [];
            const index = currentConfig.accessories.indexOf(acc);
            if(index > -1) {
                currentConfig.accessories.splice(index, 1);
            } else {
                currentConfig.accessories.push(acc);
            }
            buildAvatar();
            updateUISelection();
        };

        window.updateColor = function(key, hex) {
            currentConfig.colors[key] = hex;
            buildAvatar();
        };

        function updateUISelection() {
            document.querySelectorAll('.item-btn').forEach(btn => btn.classList.remove('selected'));
            
            // Single select items mapping based on onclick string
            ['shape', 'body', 'hair', 'eyes', 'mouth', 'clothes'].forEach(key => {
                const val = currentConfig[key];
                const btn = document.querySelector(`.item-btn[onclick="updateConfig('${key}', '${val}')"]`);
                if(btn) btn.classList.add('selected');
            });

            // Multi select
            const accs = currentConfig.accessories || [];
            document.querySelectorAll('.acc-btn').forEach(btn => {
                const onclickStr = btn.getAttribute('onclick');
                const accName = onclickStr.match(/'([^']+)'/)[1];
                if(accs.includes(accName)) btn.classList.add('selected');
            });

            // Colors
            document.getElementById('color-skin').value = currentConfig.colors.skin;
            document.getElementById('color-hair').value = currentConfig.colors.hair;
            document.getElementById('color-clothes').value = currentConfig.colors.clothes;
        }

        // Screen Management
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if(id === 'studio-screen' && !scene) {
                initThreeJS();
                buildAvatar();
                updateUISelection();
            } else if(id === 'studio-screen' && scene) {
                buildAvatar();
                updateUISelection();
            }
        }

        // Tabs Logic
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('bg-amber-100', 'text-amber-800', 'active');
                    b.classList.add('text-gray-600');
                });
                btn.classList.add('bg-amber-100', 'text-amber-800', 'active');
                btn.classList.remove('text-gray-600');

                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
            });
        });

        // --- AUTHENTICATION (RULE 3 compliance) ---
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('login-btn');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';
            loginError.classList.add('hidden');
            document.getElementById('critical-error-banner').classList.add('hidden');

            try {
                // Try Login
                await signInWithEmailAndPassword(auth, email, pass);
                // Success handled by onAuthStateChanged
            } catch (error) {
                console.error("Firebase Login Error:", error);
                
                if (error.code === 'auth/operation-not-allowed') {
                    // Fallback to anonymous auth if Email/Password is not enabled
                    console.warn("Email/Password auth disabled. Falling back to Anonymous Auth.");
                    try {
                        const userCred = await signInAnonymously(auth);
                        isFirstTime = true;
                        
                        try {
                            await setDoc(doc(usersRef, userCred.user.uid), {
                                uid: userCred.user.uid,
                                email: email,
                                score: 0,
                                avatarConfig: currentConfig,
                                avatarSnapshot: null
                            });
                        } catch (dbErr) {
                            console.error("Firestore Permission Error during Anon Login:", dbErr);
                            throw new Error("firestore-permissions");
                        }
                        
                    } catch (anonErr) {
                        if (anonErr.message === "firestore-permissions" || (anonErr.code && anonErr.code.includes('permission'))) {
                            showCriticalError("مرفوض! (صلاحيات Firestore مغلقة)", "<li>اذهب إلى Firebase Console</li><li>اختر Firestore Database</li><li>اضغط على Rules (القواعد)</li><li>ضع الكود التالي للحفظ: <code>allow read, write: if true;</code></li>");
                        } else if (anonErr.code === 'auth/operation-not-allowed') {
                            showCriticalError("تسجيل الدخول معطل تماماً!", "<li>اذهب إلى Firebase Console</li><li>اختر Authentication</li><li>اختر Sign-in method</li><li>قم بتفعيل Email/Password أو Anonymous</li>");
                        } else {
                            loginError.textContent = "حدث خطأ غير متوقع.";
                            loginError.classList.remove('hidden');
                        }
                        btn.disabled = false;
                        btn.innerHTML = '<span>دخول / ابدأ الرحلة</span><i class="fas fa-arrow-left mr-2"></i>';
                    }
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    try {
                        const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                        isFirstTime = true;
                        try {
                            // Initialize user doc
                            await setDoc(doc(usersRef, userCred.user.uid), {
                                uid: userCred.user.uid,
                                email: email,
                                score: 0,
                                avatarConfig: currentConfig,
                                avatarSnapshot: null
                            });
                        } catch (dbErr) {
                            console.error("Firestore Permission Error during Signup:", dbErr);
                            throw new Error("firestore-permissions");
                        }
                    } catch (createErr) {
                        if (createErr.message === "firestore-permissions" || (createErr.code && createErr.code.includes('permission'))) {
                            showCriticalError("الحساب تم إنشاؤه ولكن (صلاحيات Firestore مغلقة)", "<li>اذهب إلى Firebase Console</li><li>اختر Firestore Database</li><li>اضغط على Rules (القواعد)</li><li>ضع الكود: <code>allow read, write: if true;</code></li>");
                        } else {
                            loginError.textContent = "خطأ في إنشاء الحساب: " + (createErr.code === 'auth/email-already-in-use' ? 'البريد مسجل مسبقاً بكلمة مرور مختلفة' : createErr.message);
                            loginError.classList.remove('hidden');
                        }
                        btn.disabled = false;
                        btn.innerHTML = '<span>دخول / ابدأ الرحلة</span><i class="fas fa-arrow-left mr-2"></i>';
                    }
                } else {
                    // Show exact Firebase error instead of generic message
                    loginError.textContent = "حدث خطأ (" + error.code + "): " + error.message;
                    loginError.classList.remove('hidden');
                    btn.disabled = false;
                    btn.innerHTML = '<span>دخول / ابدأ الرحلة</span><i class="fas fa-arrow-left mr-2"></i>';
                }
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            signOut(auth);
            showScreen('login-screen');
        });

        // Listen for Auth State
        let unsubscribeUsers = null;
        let unsubscribeSettings = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-btn').disabled = false;
                document.getElementById('login-btn').innerHTML = '<span>دخول / ابدأ الرحلة</span><i class="fas fa-arrow-left mr-2"></i>';
                
                try {
                    // Fetch User Data
                    const docSnap = await getDoc(doc(usersRef, user.uid));
                    if(docSnap.exists()){
                        userData = docSnap.data();
                        if(userData.avatarConfig) currentConfig = userData.avatarConfig;
                        document.getElementById('current-user-score').textContent = userData.score || 0;
                    }
                } catch (dbErr) {
                    console.error("Firestore read error:", dbErr);
                }

                if (isFirstTime || !userData?.avatarSnapshot) {
                    showScreen('studio-screen');
                    isFirstTime = false;
                } else {
                    showScreen('main-screen');
                }

                // Setup Listeners
                setupListeners();

            } else {
                currentUser = null;
                if(unsubscribeUsers) unsubscribeUsers();
                if(unsubscribeSettings) unsubscribeSettings();
                showScreen('login-screen');
            }
        });

        // --- FIRESTORE LISTENERS (RULE 2 compliance - no complex queries) ---
        function setupListeners() {
            if(!currentUser) return;

            // Listen to all users for Leaderboard
            unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
                allUsers = [];
                snapshot.forEach(doc => {
                    allUsers.push(doc.data());
                });
                
                // Sort in memory (Rule 2)
                allUsers.sort((a, b) => (b.score || 0) - (a.score || 0));
                
                renderLeaderboard();
                renderAdminList();

                // Update my score
                const me = allUsers.find(u => u.uid === currentUser.uid);
                if(me) document.getElementById('current-user-score').textContent = me.score || 0;

            }, (error) => {
                console.error("Error fetching users:", error);
                if(error.code === 'permission-denied') {
                    alert("قاعدة البيانات مغلقة. يرجى تعديل Firestore Rules.");
                }
            });

            // Listen to settings for Broadcast
            unsubscribeSettings = onSnapshot(doc(settingsRef, 'global'), (docSnap) => {
                if(docSnap.exists() && docSnap.data().broadcastMessage) {
                    const newMsg = docSnap.data().broadcastMessage;
                    if(newMsg !== broadcastMsg) {
                        broadcastMsg = newMsg;
                        document.getElementById('msg-indicator').classList.remove('hidden'); // Ping!
                    }
                }
            }, (error) => {
                console.error("Error fetching settings:", error);
            });
        }

        // --- SAVING AVATAR (Performance focused snapshot) ---
        document.getElementById('btn-save-character').addEventListener('click', async () => {
            if (!currentUser) {
                showToast("يرجى تسجيل الدخول أولاً!", true);
                return;
            }

            const btn = document.getElementById('btn-save-character');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري الحفظ...';

            // Ensure rendering is up to date, reset rotation for a clear snapshot
            const prevRotation = characterGroup.rotation.y;
            characterGroup.rotation.y = 0;
            renderer.render(scene, camera);
            
            // Capture Snapshot
            const snapshotBase64 = renderer.domElement.toDataURL("image/png", 0.9);
            characterGroup.rotation.y = prevRotation;

            try {
                // Using setDoc with merge:true is safer than updateDoc to avoid "document not found" errors
                await setDoc(doc(usersRef, currentUser.uid), {
                    avatarConfig: currentConfig,
                    avatarSnapshot: snapshotBase64
                }, { merge: true });
                
                showScreen('main-screen');
                showToast("تم حفظ الشخصية بنجاح!");
            } catch (error) {
                console.error("Save Error:", error);
                if(error.code === 'permission-denied') {
                    showToast("خطأ: صلاحيات الكتابة في Firestore مغلقة (Rules).", true);
                } else {
                    showToast("حدث خطأ أثناء الحفظ. تأكد من اتصالك بالإنترنت.", true);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save ml-2"></i> حفظ وعودة';
            }
        });

        document.getElementById('btn-edit-character').addEventListener('click', () => {
            showScreen('studio-screen');
        });

        // --- LEADERBOARD RENDER ---
        function renderLeaderboard() {
            const grid = document.getElementById('leaderboard-grid');
            grid.innerHTML = '';
            
            allUsers.forEach((user, index) => {
                if(!user.avatarSnapshot) return; // Skip if no avatar yet
                
                const isMe = user.uid === currentUser?.uid;
                const emailName = user.email.split('@')[0];
                
                const card = document.createElement('div');
                card.className = `leaderboard-item glass-panel rounded-2xl p-4 flex flex-col items-center relative ${isMe ? 'ring-4 ring-amber-500 bg-amber-50' : ''}`;
                
                // Rank Badge
                const rankColor = index === 0 ? 'bg-yellow-400 text-yellow-900' : (index === 1 ? 'bg-gray-300 text-gray-800' : (index === 2 ? 'bg-amber-700 text-white' : 'bg-white/80 text-gray-600'));
                card.innerHTML = `
                    <div class="absolute -top-3 -right-3 w-8 h-8 rounded-full ${rankColor} font-bold flex justify-center items-center shadow-md border-2 border-white z-10">
                        ${index + 1}
                    </div>
                    <div class="w-24 h-24 rounded-full bg-gradient-to-b from-blue-100 to-amber-100 mb-3 border-4 ${isMe ? 'border-amber-400' : 'border-white'} shadow-inner overflow-hidden flex justify-center items-center relative">
                        <img src="${user.avatarSnapshot}" class="w-full h-full object-contain transform scale-125 pt-2" alt="Avatar">
                    </div>
                    <h3 class="font-bold text-gray-800 text-sm w-full text-center truncate px-1" title="${user.email}">${emailName}</h3>
                    <div class="mt-2 bg-amber-100 text-amber-900 font-black px-4 py-1 rounded-full text-sm w-full text-center">
                        ${user.score || 0} نقطة
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- BROADCAST MESSAGE ---
        const msgBtn = document.getElementById('btn-read-message');
        const msgModal = document.getElementById('modal-message');
        msgBtn.addEventListener('click', () => {
            document.getElementById('broadcast-content').textContent = broadcastMsg;
            msgModal.classList.remove('hidden');
            document.getElementById('msg-indicator').classList.add('hidden');
        });
        
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.fixed').classList.add('hidden');
            });
        });

        // --- ADMIN DASHBOARD ---
        const adminBtn = document.getElementById('btn-open-admin');
        const adminModal = document.getElementById('modal-admin-login');
        const verifyAdminBtn = document.getElementById('btn-verify-admin');

        adminBtn.addEventListener('click', () => {
            adminModal.classList.remove('hidden');
            document.getElementById('admin-password').value = '';
        });

        verifyAdminBtn.addEventListener('click', () => {
            if(document.getElementById('admin-password').value === '1123') {
                adminModal.classList.add('hidden');
                showScreen('admin-screen');
                document.getElementById('admin-broadcast-msg').value = broadcastMsg;
            } else {
                showToast("كلمة المرور خاطئة", true);
            }
        });

        document.getElementById('btn-close-admin').addEventListener('click', () => {
            showScreen('main-screen');
        });

        // Admin Actions
        window.adminAddPoints = async (uid, pts) => {
            const user = allUsers.find(u => u.uid === uid);
            if(user) {
                await updateDoc(doc(usersRef, uid), { score: (user.score || 0) + pts });
                showToast("تم تحديث النقاط بنجاح");
            }
        };

        window.adminKick = async (uid) => {
            await deleteDoc(doc(usersRef, uid));
            showToast("تم إزالة المستخدم من اللوحة");
        };

        document.getElementById('btn-save-broadcast').addEventListener('click', async () => {
            const msg = document.getElementById('admin-broadcast-msg').value.trim();
            if(msg) {
                await setDoc(doc(settingsRef, 'global'), { broadcastMessage: msg }, { merge: true });
                showToast("تم نشر الرسالة للجميع بنجاح!");
            }
        });

        function renderAdminList() {
            const tbody = document.getElementById('admin-users-list');
            tbody.innerHTML = '';
            
            allUsers.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 font-medium" dir="ltr">${user.email.split('@')[0]}<br><span class="text-xs text-gray-400">${user.uid}</span></td>
                    <td class="p-3 text-center font-bold text-lg">${user.score || 0}</td>
                    <td class="p-3 text-center space-x-1 space-x-reverse">
                        <button onclick="adminAddPoints('${user.uid}', 5)" class="bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">+5</button>
                        <button onclick="adminAddPoints('${user.uid}', 1)" class="bg-green-50 text-green-600 px-2 py-1 rounded hover:bg-green-100">+1</button>
                        <button onclick="adminAddPoints('${user.uid}', -1)" class="bg-red-50 text-red-600 px-2 py-1 rounded hover:bg-red-100">-1</button>
                        <button onclick="adminAddPoints('${user.uid}', -5)" class="bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">-5</button>
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="adminKick('${user.uid}')" class="bg-gray-800 text-white px-3 py-1 rounded text-xs hover:bg-black">إزالة (Kick)</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

    </script>
</body>
</html>
