<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exodus Leaderboard - مسابقة الخروج</title>
    
    <!-- Google Fonts: Cairo for Arabic, Cinzel for Titles -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs (Required for Online Sync) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --sea-dark: #0f172a;
            --sea-medium: #1e293b;
            --sea-light: #334155;
            --gold: #d4af37;
            --gold-glow: #fcd34d;
            --fire: #ef4444;
            --sand: #fef3c7;
            --text-main: #f8fafc;
        }

        * {
            box-sizing: border-box;
            user-select: none; /* Prevent selection for app-like feel */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
            background-color: var(--sea-dark);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- BACKGROUND ANIMATION (The Red Sea Split) --- */
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .sea-water {
            position: absolute;
            top: 0;
            height: 100%;
            width: 55%; /* Overlap slightly */
            background: linear-gradient(180deg, var(--sea-dark), var(--sea-medium));
            transition: transform 3s ease-in-out;
            opacity: 0.9;
        }

        .sea-left {
            left: 0;
            /* Start state */
            transform: translateX(0); 
            border-right: 2px solid rgba(255,255,255,0.1);
            animation: splitLeft 4s forwards 0.5s;
        }

        .sea-right {
            right: 0;
            transform: translateX(0);
            border-left: 2px solid rgba(255,255,255,0.1);
            animation: splitRight 4s forwards 0.5s;
        }

        .sea-path {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 100%;
            background: radial-gradient(circle at center, var(--sand) 0%, #b45309 80%);
            box-shadow: 0 0 50px var(--gold-glow);
            opacity: 0;
            animation: revealPath 4s forwards 0.5s;
        }

        /* Bubbles/Particles */
        .bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: rise 10s infinite ease-in;
            bottom: -20px;
        }

        @keyframes splitLeft {
            0% { transform: translateX(0); width: 55%; }
            100% { transform: translateX(-40%); width: 45%; } /* Move left */
        }
        @keyframes splitRight {
            0% { transform: translateX(0); width: 55%; }
            100% { transform: translateX(40%); width: 45%; } /* Move right */
        }
        @keyframes revealPath {
            0% { width: 0; opacity: 0; }
            100% { width: 30%; opacity: 0.6; }
        }
        @keyframes rise {
            0% { transform: translateY(0); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: translateY(-100vh); opacity: 0; }
        }

        /* Responsive Background for Mobile */
        @media (max-width: 768px) {
            @keyframes revealPath { 100% { width: 90%; opacity: 0.4; } }
            @keyframes splitLeft { 100% { transform: translateX(-80%); } }
            @keyframes splitRight { 100% { transform: translateX(80%); } }
        }

        /* --- UI CONTAINER --- */
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        /* --- HEADER --- */
        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 2.5rem;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
            margin-bottom: 5px;
        }

        .subtitle {
            color: #cbd5e1;
            font-size: 1rem;
            letter-spacing: 1px;
        }

        .admin-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.5);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }
        .admin-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        /* --- AUDIO PLAYER --- */
        .audio-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        .music-btn {
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--gold);
            color: var(--gold);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }
        .music-btn:hover { box-shadow: 0 0 10px var(--gold); transform: scale(1.1); }

        /* --- LEADERBOARD --- */
        .leaderboard {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 100px; /* Space for fab */
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
        }

        /* Top 3 Styling */
        .rank-1 {
            border: 2px solid var(--gold);
            background: linear-gradient(90deg, rgba(212,175,55,0.1), rgba(0,0,0,0));
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }
        .rank-1::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 2s infinite;
        }
        .rank-2 { border: 1px solid #c0c0c0; }
        .rank-3 { border: 1px solid #cd7f32; }

        @keyframes shimmer {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* Card Content */
        .rank-badge {
            font-weight: bold;
            font-size: 1.2rem;
            width: 40px;
            text-align: center;
            color: rgba(255,255,255,0.7);
        }

        .participant-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
            gap: 15px;
            margin-right: 10px; /* RTL spacing */
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.2);
            background-color: #1e293b;
        }

        .rank-1 .avatar { border-color: var(--gold); }

        .name-container {
            display: flex;
            flex-direction: column;
        }

        .name {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .title-badge {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .points-container {
            text-align: center;
            min-width: 60px;
        }

        .points {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gold);
        }

        .points-label {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.5);
        }

        /* Top 3 Icons */
        .icon-overlay {
            color: var(--gold);
            font-size: 1.2rem;
        }

        /* --- ADMIN CONTROLS (Hidden by default) --- */
        .admin-controls {
            display: none; /* Flex when active */
            gap: 10px;
            margin-right: 15px;
        }
        
        .btn-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: 0.2s;
        }
        .btn-add { background: #10b981; }
        .btn-sub { background: #ef4444; }
        .btn-edit { background: #3b82f6; }
        .btn-del { background: #64748b; }

        .host-toolbar {
            display: none; /* Block when admin */
            background: #1e293b;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--gold);
        }

        .host-toolbar h3 { margin: 0 0 10px 0; color: var(--gold); font-size: 1rem; }
        
        .toolbar-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-btn {
            background: var(--sea-light);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
        }
        .action-btn:hover { background: #475569; }
        .btn-primary { background: var(--gold); color: #000; font-weight: bold; }
        .btn-primary:hover { background: #b5932b; }
        .btn-danger { background: #7f1d1d; color: #fca5a5; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: var(--sea-medium);
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--gold);
            text-align: center;
            position: relative;
        }

        .modal h2 { margin-top: 0; color: var(--gold); }

        .input-group {
            margin-bottom: 15px;
            text-align: right;
        }

        .input-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
        
        input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #475569;
            background: #0f172a;
            color: white;
            font-family: 'Cairo', sans-serif;
        }

        .file-upload {
            border: 2px dashed #475569;
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .file-upload:hover { border-color: var(--gold); }
        
        .modal-close {
            position: absolute;
            top: 10px;
            left: 10px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 1.2rem;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <!-- Audio Element -->
    <audio id="bgMusic" loop>
        <!-- Using a free copyright calm ocean/ambient track placeholder -->
        <source src="https://cdn.pixabay.com/download/audio/2022/03/09/audio_822ca8b438.mp3?filename=calm-ocean-waves-19632.mp3" type="audio/mp3">
    </audio>

    <!-- Background Animation -->
    <div class="background-container">
        <div class="sea-path"></div>
        <div class="sea-water sea-left"></div>
        <div class="sea-water sea-right"></div>
        <!-- Bubbles generated by JS -->
        <div id="bubbles"></div>
    </div>

    <div class="app-container">
        <header>
            <button class="admin-btn" onclick="openLoginModal()"><i class="fas fa-lock"></i> دخول المشرف</button>
            <div class="audio-controls">
                <button class="music-btn" onclick="toggleMusic()" id="musicBtn"><i class="fas fa-play"></i></button>
            </div>
            <h1>مسابقة العبور</h1>
            <div class="subtitle">Exodus - Moses & The Red Sea</div>
        </header>

        <!-- Admin Toolbar (Visible only after login) -->
        <div class="host-toolbar" id="hostToolbar">
            <h3><i class="fas fa-crown"></i> لوحة تحكم القائد (المشرف)</h3>
            <div class="toolbar-grid">
                <button class="action-btn btn-primary" onclick="openAddModal()">
                    <i class="fas fa-user-plus"></i> إضافة متسابق
                </button>
                <button class="action-btn btn-danger" onclick="confirmReset()">
                    <i class="fas fa-trash-alt"></i> حذف الجميع
                </button>
                <button class="action-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
            <div style="margin-top: 10px; font-size: 0.8rem; color: #94a3b8;">
                * التغييرات تظهر فوراً لجميع الأجهزة المتصلة (إذا تم تفعيل الوضع الأونلاين).
            </div>
        </div>

        <div class="leaderboard" id="leaderboardList">
            <!-- Items rendered by JS -->
            <div style="text-align:center; padding: 20px; color: #aaa;">جاري تحميل البيانات...</div>
        </div>
    </div>

    <!-- MODAL: Login -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('loginModal')">&times;</button>
            <h2>دخول المشرف</h2>
            <p>أدخل الرمز السري للتعديل</p>
            <input type="password" id="adminPass" placeholder="كلمة السر (1123)" dir="ltr" style="text-align: center;">
            <br><br>
            <button class="action-btn btn-primary" style="width:100%" onclick="checkLogin()">دخول</button>
        </div>
    </div>

    <!-- MODAL: Add/Edit Participant -->
    <div class="modal-overlay" id="participantModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('participantModal')">&times;</button>
            <h2 id="modalTitle">إضافة متسابق</h2>
            <input type="hidden" id="editId">
            
            <div class="input-group">
                <label>الاسم</label>
                <input type="text" id="pName" placeholder="مثال: يوسف، مريم...">
            </div>

            <div class="input-group">
                <label>النقاط</label>
                <input type="number" id="pPoints" placeholder="0" value="0">
            </div>

            <div class="file-upload" onclick="document.getElementById('pImageInput').click()">
                <i class="fas fa-camera fa-2x"></i><br>
                <span>اضغط لرفع صورة</span>
                <input type="file" id="pImageInput" accept="image/*" style="display: none" onchange="previewImage()">
            </div>
            <img id="imagePreview" src="" style="width: 60px; height: 60px; border-radius: 50%; display: none; margin: 0 auto 15px auto;">

            <button class="action-btn btn-primary" style="width:100%" onclick="saveParticipant()">حفظ</button>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION & SETUP
        // ==========================================
        
        // 1. Storage Mode:
        // Set to 'LOCAL' for single device (uses localStorage).
        // Set to 'FIREBASE' for multiple devices (real-time sync).
        const STORAGE_MODE = 'LOCAL'; 

        // 2. Firebase Config (REQUIRED if STORAGE_MODE is 'FIREBASE')
        // Create a project at console.firebase.google.com -> Add Web App -> Copy config here.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        // ==========================================
        // STATE MANAGEMENT
        // ==========================================
        let competitors = [];
        let isAdmin = false;
        let db = null;
        const COLLECTION_NAME = 'exodus_competitors';

        // Placeholder data (Used only on first load/reset)
        const SAMPLE_DATA = [
            { id: '1', name: 'موسى النبي', points: 150, image: 'https://cdn-icons-png.flaticon.com/512/3024/3024607.png' },
            { id: '2', name: 'هارون', points: 120, image: 'https://cdn-icons-png.flaticon.com/512/3024/3024593.png' },
            { id: '3', name: 'مريم', points: 135, image: 'https://cdn-icons-png.flaticon.com/512/4140/4140047.png' },
            { id: '4', name: 'يشوع', points: 90, image: 'https://cdn-icons-png.flaticon.com/512/4140/4140048.png' }
        ];

        // ==========================================
        // INITIALIZATION
        // ==========================================
        window.onload = function() {
            initBubbles();
            
            if (STORAGE_MODE === 'FIREBASE') {
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    console.log("Firebase initialized");
                    initRealtimeListener();
                } catch (e) {
                    alert("خطأ في الاتصال: تأكد من وضع إعدادات Firebase في الكود.");
                    console.error(e);
                    // Fallback
                    loadFromLocal();
                }
            } else {
                loadFromLocal();
            }
        };

        // --- Data Loading Logic ---
        function loadFromLocal() {
            const stored = localStorage.getItem('exodusData');
            if (stored) {
                competitors = JSON.parse(stored);
            } else {
                competitors = [...SAMPLE_DATA]; // Load samples
                saveData();
            }
            renderLeaderboard();
        }

        function initRealtimeListener() {
            db.collection(COLLECTION_NAME).onSnapshot((snapshot) => {
                competitors = [];
                snapshot.forEach((doc) => {
                    competitors.push({ id: doc.id, ...doc.data() });
                });
                renderLeaderboard();
            });
        }

        // --- Data Saving Logic ---
        function saveData() {
            if (STORAGE_MODE === 'LOCAL') {
                localStorage.setItem('exodusData', JSON.stringify(competitors));
                renderLeaderboard();
            } else {
                // In Firebase mode, save functions handle DB calls directly
            }
        }

        // ==========================================
        // RENDERING
        // ==========================================
        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';

            // Sort: High to Low
            competitors.sort((a, b) => b.points - a.points);

            if (competitors.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px;">لا يوجد متسابقين حالياً</div>';
                return;
            }

            competitors.forEach((p, index) => {
                const rank = index + 1;
                let rankClass = '';
                let icon = '';
                let glowEffect = '';

                // Theme Logic for Top 3
                if (rank === 1) {
                    rankClass = 'rank-1';
                    icon = '<i class="fas fa-staff-snake icon-overlay" title="عصا موسى"></i> <span class="title-badge">قائد العبور</span>';
                } else if (rank === 2) {
                    rankClass = 'rank-2';
                    icon = '<i class="fas fa-tablet-alt icon-overlay" title="لوحي الشريعة"></i>';
                } else if (rank === 3) {
                    rankClass = 'rank-3';
                    icon = '<i class="fas fa-fire icon-overlay" title="عمود النار"></i>';
                }

                const div = document.createElement('div');
                div.className = `card ${rankClass}`;
                div.innerHTML = `
                    <div class="participant-info">
                        <div class="rank-badge">${rank}</div>
                        <img src="${p.image || 'https://via.placeholder.com/50'}" class="avatar" alt="${p.name}">
                        <div class="name-container">
                            <span class="name">${p.name}</span>
                            <span class="title-badge">${icon}</span>
                        </div>
                    </div>

                    <div class="points-container">
                        <div class="points">${p.points}</div>
                        <div class="points-label">نقاط</div>
                    </div>

                    <div class="admin-controls" style="display: ${isAdmin ? 'flex' : 'none'}">
                        <button class="btn-circle btn-sub" onclick="updatePoints('${p.id}', -10)">-10</button>
                        <button class="btn-circle btn-add" onclick="updatePoints('${p.id}', 10)">+10</button>
                        <button class="btn-circle btn-edit" onclick="editParticipant('${p.id}')"><i class="fas fa-pen"></i></button>
                        <button class="btn-circle btn-del" onclick="deleteParticipant('${p.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // ==========================================
        // ADMIN ACTIONS
        // ==========================================
        
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function checkLogin() {
            const pass = document.getElementById('adminPass').value;
            if (pass === '1123') {
                isAdmin = true;
                document.getElementById('hostToolbar').style.display = 'block';
                document.querySelector('.admin-btn').style.display = 'none'; // Hide login btn
                closeModal('loginModal');
                renderLeaderboard(); // Re-render to show controls
                alert('مرحباً أيها القائد. يمكنك الآن تعديل النتائج.');
            } else {
                alert('كلمة المرور خاطئة');
            }
        }

        function logout() {
            isAdmin = false;
            document.getElementById('hostToolbar').style.display = 'none';
            document.querySelector('.admin-btn').style.display = 'block';
            renderLeaderboard();
        }

        function confirmReset() {
            if(confirm("هل أنت متأكد؟ سيتم حذف جميع المتسابقين!")) {
                if (STORAGE_MODE === 'LOCAL') {
                    competitors = [];
                    saveData();
                } else {
                    // Firebase Delete All (Batch)
                    competitors.forEach(p => {
                        db.collection(COLLECTION_NAME).doc(p.id).delete();
                    });
                }
            }
        }

        // ==========================================
        // DATA CRUD (Create, Read, Update, Delete)
        // ==========================================

        function updatePoints(id, amount) {
            if (STORAGE_MODE === 'LOCAL') {
                const p = competitors.find(c => c.id === id);
                if (p) {
                    p.points = parseInt(p.points) + amount;
                    saveData();
                }
            } else {
                const p = competitors.find(c => c.id === id);
                db.collection(COLLECTION_NAME).doc(id).update({
                    points: parseInt(p.points) + amount
                });
            }
        }

        function deleteParticipant(id) {
            if(!confirm("حذف المتسابق؟")) return;
            
            if (STORAGE_MODE === 'LOCAL') {
                competitors = competitors.filter(c => c.id !== id);
                saveData();
            } else {
                db.collection(COLLECTION_NAME).doc(id).delete();
            }
        }

        // Modal Handling
        function openAddModal() {
            document.getElementById('modalTitle').innerText = 'إضافة متسابق جديد';
            document.getElementById('editId').value = '';
            document.getElementById('pName').value = '';
            document.getElementById('pPoints').value = 0;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('participantModal').style.display = 'flex';
        }

        function editParticipant(id) {
            const p = competitors.find(c => c.id === id);
            if (!p) return;

            document.getElementById('modalTitle').innerText = 'تعديل بيانات';
            document.getElementById('editId').value = id;
            document.getElementById('pName').value = p.name;
            document.getElementById('pPoints').value = p.points;
            if(p.image) {
                const img = document.getElementById('imagePreview');
                img.src = p.image;
                img.style.display = 'block';
            }
            document.getElementById('participantModal').style.display = 'flex';
        }

        async function saveParticipant() {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('pName').value;
            const points = parseInt(document.getElementById('pPoints').value);
            const fileInput = document.getElementById('pImageInput');
            
            if (!name) return alert("الاسم مطلوب");

            let imageBase64 = null;
            
            // Handle Image
            if (fileInput.files && fileInput.files[0]) {
                try {
                    imageBase64 = await resizeImage(fileInput.files[0]);
                } catch (e) {
                    alert("خطأ في الصورة");
                    return;
                }
            } else if (id) {
                // Keep existing image if editing
                const existing = competitors.find(c => c.id === id);
                imageBase64 = existing.image;
            } else {
                // Default avatar
                imageBase64 = 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
            }

            const newDoc = {
                name: name,
                points: points,
                image: imageBase64
            };

            if (STORAGE_MODE === 'LOCAL') {
                if (id) {
                    const index = competitors.findIndex(c => c.id === id);
                    competitors[index] = { id, ...newDoc };
                } else {
                    newDoc.id = Date.now().toString();
                    competitors.push(newDoc);
                }
                saveData();
            } else {
                if (id) {
                    db.collection(COLLECTION_NAME).doc(id).update(newDoc);
                } else {
                    db.collection(COLLECTION_NAME).add(newDoc);
                }
            }

            closeModal('participantModal');
            // Clear input
            fileInput.value = '';
        }

        // ==========================================
        // UTILITIES & VISUALS
        // ==========================================
        
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function toggleMusic() {
            const audio = document.getElementById('bgMusic');
            const btn = document.getElementById('musicBtn');
            if (audio.paused) {
                audio.play();
                btn.innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                audio.pause();
                btn.innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        // Helper to resize images (Base64 is heavy, so we shrink it)
        function resizeImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // Max dimensions
                        const MAX_WIDTH = 200;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); // Compress to 0.7 quality
                    };
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function previewImage() {
            const file = document.getElementById('pImageInput').files[0];
            const preview = document.getElementById('imagePreview');
            const reader = new FileReader();
            reader.onloadend = function () {
                preview.src = reader.result;
                preview.style.display = "block";
            }
            if (file) { reader.readAsDataURL(file); }
        }

        function initBubbles() {
            const container = document.getElementById('bubbles');
            for(let i=0; i<15; i++) {
                const b = document.createElement('div');
                b.className = 'bubble';
                b.style.left = Math.random() * 100 + '%';
                b.style.width = (Math.random() * 10 + 5) + 'px';
                b.style.height = b.style.width;
                b.style.animationDuration = (Math.random() * 5 + 5) + 's';
                b.style.animationDelay = (Math.random() * 5) + 's';
                container.appendChild(b);
            }
        }

    </script>
</body>
</html>
